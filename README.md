# Домашнее задание к занятию "12.8 Резервное копирование баз данных" - `Андрей Сотников`

### Задание 1. Резервное копирование

### Кейс
> Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 
> 
> Необходимо описать, какие варианты резервного копирования подходят в случаях: 
>
> 1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

Подойдет еженедельное резервное копирование + настроенное на ежедневную работу дифференциальное. 

> 1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

В этом случае, думаю, отлично подойдет предыдущий вариант + ежечасное инкрементальное резервное копирование. Это позволит делать бэкапы чаще, не занимая много дискового пространства.  
Однако, расплачиваться придется временем восстановления.

> 1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Для этого необходимо использовать репликацию базы с инстансами на разных серверах и автоматически переназначать мастер-ноду на работающий экземпляр в случае проблем.
Существуют различные решения для реализации такой архитектуры, в том числе различные самописные скрипты разной степени надежности. 
Но есть и готовые решения, например, Patroni для PostgreSQL, с помощью которого можно построить высокодоступный кластер, который будет автоматически отслеживать состояние репликации и при необходимости быстро переключать ведущую ноду.


---

### Задание 2. PostgreSQL

> 2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

Резервирование:

Для резервнирования базы данных предназначена утилита `pg_dump`. Синтаксис:

`pg_dump [опции-подключения...] [опции...] [имя-базы-данных]`

С ее помощью можно делать дамп как всей базы целиком, так и частично схем/таблиц с данными, или только данные, или только схемы. Различных опций довольно много, можно гибко настроить выгрузку под свои потребности.
Дамп представляет собой SQL-скрипт или архив, который без проблем можно восстановить.

В простейшем случае команда для выгрузки дампа выглядит так:

`pg_dump my_database > dump.sql`

Утилита `pg_dump` позволяет сделать дамп только одной базы, для резервирования всех баз можно использовать утилиту `pg_dumpall`, которая так же предоставляет обширное количество опций.

Восстановление БД из дампа можно произвести при помощи утилиты `pg_restore`. Она позволяет восстановить не все содержимое дампа, а только то, что нужно в данный момент.
Синтаксис похож на `pg_dump`:

`pg_restore [опции-подключения...] [опции...] [имя-файла]`

Пример команды для загрузки в простейшем случае:

`pg_restore -d my_database dump.sql`

Все эти утилиты можно использовать на удаленном сервере, подключаясь к нужной базе данных.

> 2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Автоматизировать процесс можно при помощи, например, утилиты `crontab`, которая с заданной периодичностью будет выгружать дамп с заданными характеристиками или выполнять нужный скрипт.
Для PostgreSQL также существует несколько решений (например, Barman, PgBackRest, WAL-G и другие), которые обеспечивают резервное копирование, его ротацию, возможность отката на определенную точку, шифрование, проверку бэкапа и другие важные функции. 

---

### Задание 3. MySQL

> 3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

Если я правильно понял, в официальной документации говорится, что инкрементное резервное копирование для MySQL доступно только в MySQL Enterprise Backup, причем только для движка InnoDB. 
Не-InnoDB базы либо выгружаются полностью, либо не выгружаются вообще при использовании опции `--only-innodb`.

Синтаксис команды для инкрементного бэкапа в директорию:

``` sh
mysqlbackup --defaults-file=/home/dbadmin/my.cnf --incremental \
  --incremental-base=dir:/incr-backup/wednesday \
  --incremental-backup-dir=/incr-backup/thursday \
  backup
```

где
  `--defaults-file` - указание файла с конфигурацией,
  `--incremental` - опция для запуска инкрементного резервного копирования, 
  `--incremental-base` - обязательная опция с указанием имеющегося бэкапа, для которого нужно сделать инкремент,
  `--incremental-backup-dir` - опция с указанием директории назначения

> 3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

В случае, если нельзя допускать перерывов в работе базы данных, например, для высоконагруженных систем, так как на время восстановления из резервной копии база недоступна.

